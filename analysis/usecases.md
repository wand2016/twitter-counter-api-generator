# 方向性

- GitHubの草みたいなものをtwitter検索結果に対して生やしたい
- 草を生やすのはフロントエンドで良しなに行うとして、JSONエンドポイントを作成したい

```
GET /path/to/api/syaroshico.json
```

```json
{
  "daily": [
    {
      "date": "2020-09-16",
      "count": 4545
    }
  ]
}
```

- 上記では、「syaroshico OR シャロシコ」をtwitter検索した結果が返る感じ
- 「syaroshico OR シャロシコ」のようなものを「tweet検索条件」と呼ぶことにする
  - tweet検索APIを呼び出す際の、tweet日時以外のtweet検索条件


## やること ##

- 日毎に毎日集計し、永続化する
  - twitterの検索APIは開発者に公開されている範囲では直近7日ぶんしかデータを収集できない

## やらないこと ##

- リアルタイム取得
  - 少なくともプロトタイプでは要らないかなと
- 8日以上昔の集計結果の修正
  - そもそも不可能なので


# ユースケース記述 #

## tweet検索条件を登録する ##

- `利用者`は、`tweet検索条件`の登録内容を入力し、`登録`を押下する:
  - tweet検索条件名(任意の文字種、~32文字)
  - ファイル名(`^[a-z_-]{1,16}$`)
    - `.json`が補われる
    - 「tweet検索条件」ではないのでエンティティ分けるべきな気もする
  - 検索対象twitterアカウントユーザー名(オプション、~15文字)
  - 検索キーワード(10個まで、~32文字)
- システムは、`tweet検索条件`の入力値を検証する。
  - 入力値の型など
- システムは、`tweet検索条件`の登録内容を検証する。
  - 長さなど、ロジックの絡むもの
  - 一意制約など、DBの絡むもの
- システムは、`tweet検索条件`を永続化する。
- システムは、tweet検索条件の永続化完了を利用者に通知する。

### 代替フロー: 入力不正・内容不正 ###

- バリデーションエラーを返す

### 代替フロー: 永続化エラー ###

- DBトランザクションをロールバックする。
- 永続化に失敗した旨を返す。


## 検索・集計 ##

- `定期実行ジョブ`は、`tweet検索集計実行コマンド`を実行する。
  - `tweet検索期間`
    - 開始日 (7日前まで)
    - 終了日 (当日まで)
  - `tweet検索条件`ID
- システムは、コマンドの入力値を検証する。
- システムは、tweet検索条件IDを用いて`tweet検索条件`を読み込む。
- システムは、tweet検索APIをコールする。
- システムは、レスポンスをパースして、`tweetコレクション`を得る。
- システムは、`tweetコレクション`を日次集計し、`tweet検索集計結果`を得る。
  - `tweet検索条件`
  - `日次tweet数`のコレクション
    - 年月日
    - 件数
- システムは、`tweet検索集計結果`を永続化する。
- システムは、集計完了をジョブに通知する。


### 代替フロー: 入力不正 ###

- バリデーションエラーを返す


### 代替フロー: 指定のtweet検索条件なし ###

- 当該`tweet検索条件`が見つからなかった旨を返す

### 代替フロー: twitter APIコール失敗 ###

- ステータスコードと失敗理由を返す
  - クエリ不正
  - レートリミット
  - etc.

### 代替フロー: tweet検索集計結果の永続化エラー ###

- DBトランザクションをロールバックする。
- 永続化に失敗した旨を返す。
